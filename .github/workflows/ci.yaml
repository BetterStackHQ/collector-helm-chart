name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Install Helm
        uses: azure/setup-helm@v4.3.0

      - name: Lint chart
        run: helm lint . --set collector.env.COLLECTOR_SECRET=test123

      - name: Test template with COLLECTOR_SECRET
        run: helm template test . --set collector.env.COLLECTOR_SECRET=test123

      - name: Test template with envFrom
        run: helm template test . --set-json 'collector.envFrom=[{"secretRef":{"name":"my-secret"}}]'

      - name: Test template with collectOtel ports
        run: |
          output=$(helm template test . --set collector.env.COLLECTOR_SECRET=test123 --set collectOtel.grpcPort=4317 --set collectOtel.httpPort=4318)
          echo "$output" | grep -q 'hostPort: 4317' || { echo "Missing hostPort 4317"; exit 1; }
          echo "$output" | grep -q 'hostPort: 4318' || { echo "Missing hostPort 4318"; exit 1; }
          echo "$output" | grep -q 'containerPort: 4317' || { echo "Missing containerPort 4317"; exit 1; }
          echo "$output" | grep -q 'containerPort: 4318' || { echo "Missing containerPort 4318"; exit 1; }
          echo "$output" | grep -q 'COLLECT_OTEL_GRPC_PORT' || { echo "Missing COLLECT_OTEL_GRPC_PORT env var"; exit 1; }
          echo "$output" | grep -q 'COLLECT_OTEL_HTTP_PORT' || { echo "Missing COLLECT_OTEL_HTTP_PORT env var"; exit 1; }

      - name: Test template without collectOtel ports has no otel ports
        run: |
          output=$(helm template test . --set collector.env.COLLECTOR_SECRET=test123)
          if echo "$output" | grep -q 'otel-grpc\|otel-http'; then
            echo "Unexpected otel ports when collectOtel ports are not set"
            exit 1
          fi
          if echo "$output" | grep -q 'COLLECT_OTEL_GRPC_PORT\|COLLECT_OTEL_HTTP_PORT'; then
            echo "Unexpected COLLECT_OTEL env vars when collectOtel ports are not set"
            exit 1
          fi

      - name: Test validation fails without secret
        run: |
          if helm template test . 2>&1; then
            echo "Expected validation to fail but it passed"
            exit 1
          fi
