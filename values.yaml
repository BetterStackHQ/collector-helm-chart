# Default values for better-stack-collector
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Collector configuration
collector:
  image:
    repository: betterstack/collector
    tag: latest
    pullPolicy: Always

  # Environment variables
  env:
    COLLECTOR_SECRET: ""  # Required: Your collector secret
    BASE_URL: "https://telemetry.betterstack.com"
    CLUSTER_COLLECTOR: ""
    VECTOR_LOG_FORMAT: "json"

  # Resource limits and requests
  resources:
    limits:
      cpu: 1200m
      memory: 1Gi
    requests:
      cpu: 800m
      memory: 1Gi

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

  # Service configuration
  service:
    type: ClusterIP
    port: 34320

  # Port for internal OTLP communication
  otlpPort: 34320

  # Host filesystem mount configuration
  # By default, mounts the entire host root filesystem at /host (read-only)
  # You can specify specific paths to mount instead. Each path will be mounted
  # under /host with the same path structure (e.g., /var/www -> /host/var/www)
  hostMounts:
    # Array of host paths to mount. If empty, mounts root filesystem
    # Example: ["/var/www/custom", "/var/lib/something"]
    paths: []

# Beyla configuration for eBPF tracing
beyla:
  enabled: true

  image:
    repository: betterstack/collector-beyla
    tag: latest
    pullPolicy: Always

  # Environment variables
  env:
    OTEL_EXPORTER_OTLP_ENDPOINT: http://localhost:34320
    OTEL_EXPORTER_OTLP_PROTOCOL: "http/protobuf"
    BEYLA_DISCOVERY_POLL_INTERVAL: "30s"
    BEYLA_MIN_PROCESS_AGE: "20s"
    BEYLA_OPEN_PORT: ""         # Set to "1-32767" to skip ephemeral ports, set to "1-65535" to enable all ports
    BEYLA_PROFILE_PORT: ""      # Set to 6060 for profiling
    BEYLA_LOG_LEVEL: ""         # Options: debug, info, warn, error
    OTEL_TRACES_SAMPLER: "" "   # Set to "traceidratio" for sampling
    OTEL_TRACES_SAMPLER_ARG: "" # Set to "0.1" for 10% sampling
    OTEL_EBPF_NETWORK_CACHE_MAX_FLOWS: ""
    BEYLA_EXCLUDE_OTEL_INSTRUMENTED_SERVICES: ""
    BEYLA_BPF_CONTEXT_PROPAGATION: ""
    BEYLA_BPF_TRACK_REQUEST_HEADERS: ""

    # Kubernetes metadata for just current node
    BEYLA_KUBE_METADATA_ENABLE: "true"
    BEYLA_KUBE_META_RESTRICT_LOCAL_NODE: "true"

    # Makes garbage collection more aggressive once memory is over this threshold
    # Too low might cause GC to run too often and increase CPU usage
    GOMEMLIMIT: 1400MiB

  # Docker probe configuration
  dockerprobe:
    enabled: false

  # Resource limits and requests
  resources:
    limits:
      cpu: 1000m
      memory: 3000Mi # Beyla spikes to about 2GiB after start up
    requests:
      cpu: 800m
      memory: 1000Mi # Then drops to about 200-500MiB depending on cluster size

  # Memory restart threshold in MiB (optional)
  # If set, beyla will restart when memory usage exceeds this value
  # Should be set below the memory limit to prevent OOM kills
  memoryRestartThreshold: 1450

# RBAC configuration
rbac:
  # Create service account
  create: true
  # Service account name
  serviceAccountName: better-stack-collector

# Security context for pods
securityContext:
  # For collector deployment
  collector:
    runAsNonRoot: false
    runAsUser: 0
    fsGroup: 0

  # For Beyla daemonset (requires privileged access)
  beyla:
    privileged: true

# Image pull secrets
imagePullSecrets: []

# Global labels to add to all resources
commonLabels: {}

# Global annotations to add to all resources
commonAnnotations: {}

# Shared volumes configuration
volumes:
  # Docker metadata volume shared between collector and beyla
  dockerMetadata:
    # Mount path for the docker metadata volume
    mountPath: /enrichment
